var VirtualMachine=function(t){var r={};function o(e){if(r[e])return r[e].exports;var s=r[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.m=t,o.c=r,o.d=function(t,r,e){o.o(t,r)||Object.defineProperty(t,r,{enumerable:!0,get:e})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,r){if(1&r&&(t=o(t)),8&r)return t;if(4&r&&"object"==typeof t&&t&&t.__esModule)return t;var e=Object.create(null);if(o.r(e),Object.defineProperty(e,"default",{enumerable:!0,value:t}),2&r&&"string"!=typeof t)for(var s in t)o.d(e,s,function(r){return t[r]}.bind(null,s));return e},o.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(r,"a",r),r},o.o=function(t,r){return Object.prototype.hasOwnProperty.call(t,r)},o.p="",o(o.s=496)}({113:function(t,r,o){const{motionVector:e,scratchAtan2:s}=o(77);t.exports=class{constructor(){this.frameNumber=0,this.lastAnalyzedFrame=0,this.motionAmount=0,this.motionDirection=0,this.curr=null,this.prev=null,this._arrays=new ArrayBuffer(460800),this._curr=new Uint8ClampedArray(this._arrays,0,230400),this._prev=new Uint8ClampedArray(this._arrays,230400,230400)}reset(){this.frameNumber=0,this.lastAnalyzedFrame=0,this.motionAmount=this.motionDirection=0,this.prev=this.curr=null}addFrame(t){this.frameNumber++,this.prev=this.curr,this.curr=new Uint32Array(t.buffer.slice(0));const r=this._prev;this._prev=this._curr,this._curr=r;for(let t=0;t<this.curr.length;t++)this._curr[t]=255&this.curr[t]}analyzeFrame(){if(!this.curr||!this.prev)return void(this.motionAmount=this.motionDirection=-1);if(this.lastAnalyzedFrame===this.frameNumber)return;this.lastAnalyzedFrame=this.frameNumber;const{_curr:t,_prev:r}=this;let o=0,n=0,i=0;for(let s=9;s<351;s+=17)for(let a=9;a<631;a+=17){let h=0,u=0,c=0,l=0,d=0,m=640*(s-8)+a-8,f=m+17;const g=640*(s+8)+a+8;for(;m<=g;m+=623,f+=640)for(;m<=f;m+=1){const o=r[m]-t[m],e=t[m-1]-t[m+1],s=t[m-640]-t[m+640];h+=e*e,u+=e*s,c+=s*s,d+=e*o,l+=s*o}const{u:p,v:_}=e(h,u,c,d,l);-17<p&&p<17&&-17<_&&_<17&&(o+=p,n+=_,i++)}o/=i,n/=i,this.motionAmount=Math.round(100*Math.hypot(o,n)),this.motionAmount>10&&(this.motionDirection=s(n,o))}getLocalMotion(t,r){if(this.curr&&this.prev){if(r.motionFrameNumber!==this.frameNumber){const{_prev:o,_curr:n}=this;t.updateCPURenderAttributes();const i=t.getFastBounds(),a=Math.max(Math.floor(i.left+320),1),h=Math.min(Math.floor(i.right+320),639),u=Math.max(Math.floor(180-i.top),1),c=Math.min(Math.floor(180-i.bottom),359);let l=0,d=0,m=0,f=0,g=0,p=0;const _=[0,0,0];for(let r=u;r<c;r++)for(let e=a;e<h;e++)if(_[0]=e-320,_[1]=180-r,t.isTouching(_)){const t=640*r+e,s=o[t]-n[t],i=n[t-1]-n[t+1],a=n[t-640]-n[t+640];l+=i*i,d+=i*a,m+=a*a,g+=i*s,f+=a*s,p++}let{u:M,v:A}=e(l,d,m,g,f),C=0;p&&(C=p,p/=256,M/=p,A/=p),r.motionAmount=Math.round(.02*C*Math.hypot(M,A)),r.motionAmount>100&&(r.motionAmount=100),r.motionAmount>10/3&&(r.motionDirection=s(A,M)),r.motionFrameNumber=this.frameNumber}}else r.motionAmount=r.motionDirection=-1}}},496:function(t,r,o){(function(r){t.exports=r.Scratch3VideoSensingDebug=o(497)}).call(this,o(5))},497:function(t,r,o){const e=o(113),s=o(498);t.exports={VideoMotion:e,VideoMotionView:s}},498:function(t,r,o){const{motionVector:e}=o(77),s={INPUT:-1,XY:0,XY_CELL:1,AB:2,AB_CELL:3,T:4,T_CELL:5,XYT:6,XYT_CELL:7,C:8,C_CELL:9,UV:10,UV_CELL:11},n={A2:0,A1B2:0,B1:0,C2:0,C1:0};t.exports=class{constructor(t,r=s.XYT){this.motion=t;const o=this.canvas=document.createElement("canvas");o.width=640,o.height=360,this.context=o.getContext("2d"),this.output=r,this.buffer=new Uint32Array(230400)}static get OUTPUT(){return s}_eachAddress(t,r,o,e,s){for(let n=r;n<e;n++)for(let r=t;r<o;r++){s(640*n+r,r,n)}}_eachCell(t,r,o,e,s,n,i){const a=s/2|0,h=n/2|0;for(let u=r;u<e;u+=n)for(let r=t;r<o;r+=s)i(t=>this._eachAddress(r-a-1,u-h-1,r+a,u+h,t),r-a-1,u-h-1,r+a,u+h)}_grads(t){const{curr:r,prev:o}=this.motion;return{gradX:(255&r[t-1])-(255&r[t+1]),gradY:(255&r[t-640])-(255&r[t+640]),gradT:(255&o[t])-(255&r[t])}}_components(t){let r=0,o=0,e=0,s=0,i=0;return t(t=>{const{gradX:n,gradY:a,gradT:h}=this._grads(t);r+=n*n,o+=n*a,e+=a*a,s+=n*h,i+=a*h}),n.A2=r,n.A1B2=o,n.B1=e,n.C2=s,n.C1=i,n}draw(){if(!this.motion.prev||!this.motion.curr)return;const{buffer:t}=this;if(this.output===s.INPUT){const{curr:r}=this.motion;this._eachAddress(1,1,639,359,o=>{t[o]=r[o]})}if(this.output===s.XYT&&this._eachAddress(1,1,639,359,r=>{const{gradX:o,gradY:e,gradT:s}=this._grads(r),n=s/207;t[r]=(255<<24)+(Math.floor((255+(e*n&255))/2)<<8)+Math.floor((255+(o*n&255))/2)}),this.output===s.XYT_CELL){const r=17,o=631,e=351;this._eachCell(9,9,o,e,r,r,r=>{let o=0,e=0,s=0;r(t=>{const{gradX:r,gradY:n,gradT:i}=this._grads(t);e+=Math.max(Math.min(r/15,1),-1)*(i/255),o+=Math.max(Math.min(n/15,1),-1)*(i/255),s+=1}),o/=s,e/=s,o=Math.log(o+1*Math.sign(o))/Math.log(2),e=Math.log(e+1*Math.sign(e))/Math.log(2),r(r=>{t[r]=(255<<24)+(128+(127*o|0)<<8&65280)+(128+(127*e|0)<<0&255)})})}if(this.output===s.XY&&this._eachAddress(1,1,639,359,r=>{const{gradX:o,gradY:e}=this._grads(r);t[r]=(255<<24)+((e+255)/2<<8)+(o+255)/2}),this.output===s.XY_CELL){const r=17,o=631,e=351;this._eachCell(9,9,o,e,r,r,r=>{let o=0,e=0,s=0;r(t=>{const{gradX:r,gradY:n}=this._grads(t);e+=Math.max(Math.min(r/31,1),-1),o+=Math.max(Math.min(n/31,1),-1),s+=1}),o/=s,e/=s,o=Math.log(o+1*Math.sign(o))/Math.log(2),e=Math.log(e+1*Math.sign(e))/Math.log(2),r(r=>{t[r]=(255<<24)+(128+(127*o|0)<<8&65280)+(128+(127*e|0)<<0&255)})})}else this.output===s.T&&this._eachAddress(1,1,639,359,r=>{const{gradT:o}=this._grads(r);t[r]=(255<<24)+((o+255)/2<<16)});if(this.output===s.T_CELL){const r=17,o=631,e=351;this._eachCell(9,9,o,e,r,r,r=>{let o=0,e=0;r(t=>{const{gradT:r}=this._grads(t);o+=r/255,e+=1}),o/=e,r(r=>{t[r]=(255<<24)+(128+(127*o|0)<<16&16711680)})})}else this.output===s.C&&this._eachAddress(1,1,639,359,r=>{const{gradX:o,gradY:e,gradT:s}=this._grads(r);t[r]=(255<<24)+((15*Math.sqrt(e*s)&255)<<8)+(15*Math.sqrt(o*s)&255)});if(this.output===s.C_CELL){const r=17,o=631,e=351;this._eachCell(9,9,o,e,r,r,r=>{let{C2:o,C1:e}=this._components(r);o=Math.sqrt(o),e=Math.sqrt(e),r(r=>{t[r]=(255<<24)+((255&e)<<8)+((255&o)<<0)})})}else this.output===s.AB&&this._eachAddress(1,1,639,359,r=>{const{gradX:o,gradY:e}=this._grads(r);t[r]=(255<<24)+((o*e&255)<<16)+((e*e&255)<<8)+(o*o&255)});if(this.output===s.AB_CELL){const r=17,o=631,e=351;this._eachCell(9,9,o,e,r,r,r=>{let{A2:o,A1B2:e,B1:s}=this._components(r);o=Math.sqrt(o),e=Math.sqrt(e),s=Math.sqrt(s),r(r=>{t[r]=(255<<24)+((255&e)<<16)+((255&s)<<8)+(255&o)})})}else if(this.output===s.UV){const r=17;this._eachAddress(1,1,639,359,o=>{const{A2:s,A1B2:n,B1:i,C2:a,C1:h}=this._components(t=>t(o)),{u:u,v:c}=e(s,n,i,a,h),l=-r<u&&u<r&&-r<c&&c<r,d=100*Math.hypot(u,c);t[o]=(255<<24)+(l&&d>10?((c/r+1)/2*255<<8&65280)+((u/r+1)/2*255<<0&255):32896)})}else if(this.output===s.UV_CELL){const r=17,o=631,s=351;this._eachCell(9,9,o,s,r,r,o=>{const{A2:s,A1B2:n,B1:i,C2:a,C1:h}=this._components(o),{u:u,v:c}=e(s,n,i,a,h),l=-r<u&&u<r&&-r<c&&c<r,d=100*Math.hypot(u,c);o(o=>{t[o]=(255<<24)+(l&&d>10?((c/r+1)/2*255<<8&65280)+((u/r+1)/2*255<<0&255):32896)})})}const r=new ImageData(new Uint8ClampedArray(this.buffer.buffer),640,360);this.context.putImageData(r,0,0)}}},5:function(t,r){var o;o=function(){return this}();try{o=o||new Function("return this")()}catch(t){"object"==typeof window&&(o=window)}t.exports=o},77:function(t,r){const o=180/Math.PI,e={u:0,v:0},s=function(t){return(t+270)%360-180};t.exports={motionVector:function(t,r,o,s,n,i=e){const a=r*r-t*o;if(a){const e=-(n*r-s*o),h=-(r*s-t*n),u=8/a;i.u=e*u,i.v=h*u}else{const e=(r+t)*(r+t)+(o+r)*(o+r);if(e){const a=-(n+s)*(8/e);i.u=(r+t)*a,i.v=(o+r)*a}else i.u=0,i.v=0}return i},scratchDegrees:s,scratchAtan2:function(t,r){return s(Math.atan2(t,r)*o)}}}});
//# sourceMappingURL=video-sensing-extension-debug.js.map